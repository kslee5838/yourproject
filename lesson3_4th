CREATE TABLE album (
  id SERIAL,
  title VARCHAR(128) UNIQUE,
  PRIMARY KEY(id)
);

CREATE TABLE artist (
  id SERIAL,
  title VARCHAR(128) UNIQUE,
  PRIMARY KEY(id)
);

CREATE TABLE track (
    id SERIAL,
    title VARCHAR(128),
    album_id INTEGER REFERENCES album(id) ON DELETE CASCADE,
    UNIQUE(title, album_id),
    PRIMARY KEY(id)
);

CREATE TABLE tracktoartist (
  id SERIAL,
  title VARCHAR(128),
  artist_id INTEGER REFERENCES artist(id) ON DELETE CASCADE,
  tracK_id INTEGER REFERENCES track(id) ON DELETE CASCADE, 
  UNIQUE(title, artist_id),
  PRIMARY KEY(id)
);
DROP TABLE IF EXISTS track_raw;
CREATE TABLE track_raw
 (title TEXT, artist TEXT,artist_id INTEGER,album TEXT, album_id INTEGER,
  count INTEGER, rating INTEGER, len INTEGER);

\copy track_raw(title, artist , album, count, rating, len) FROM 'library.csv' WITH DELIMITER ',' CSV HEADER;

INSERT INTO album(title) SELECT DISTINCT title FROM track_raw;
UPDATE track_raw SET album_id = (SELECT album.id FROM album WHERE album.title = track_raw.album);
INSERT INTO track (title, album_id) SELECT title, album_id FROM track_raw;

INSERT INTO artist(title) SELECT DISTINCT artist FROM track_raw;
UPDATE track_raw SET artist_id = (SELECT artist.id FROM artist WHERE artist.title = track_raw.artist);
INSERT INTO tracktoartist (title, artist_id) SELECT title, artist_id FROM track_raw;

INSERT INTO track(title) SELECT DISTINCT title FROM track_raw;
UPDATE track_raw SET track_id = (SELECT track.id FROM track WHERE track.title = track_raw.title);

